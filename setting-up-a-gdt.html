<!DOCTYPE HTML>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <title>Setting up a GDT - intermezzOS</title>
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <base href="">

        <link rel="stylesheet" href="book.css">
        <link href='https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/css'>

        <link rel="shortcut icon" href="favicon.png">

        <!-- Font Awesome -->
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">

        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">

        <!-- MathJax -->
        <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

        <!-- Fetch JQuery from CDN but have a local fallback -->
        <script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
        <script>
            if (typeof jQuery == 'undefined') {
                document.write(unescape("%3Cscript src='jquery.js'%3E%3C/script%3E"));
            }
        </script>
    </head>
    <body class="light">
        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme = localStorage.getItem('theme');
            if (theme == null) { theme = 'light'; }
            $('body').removeClass().addClass(theme);
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var sidebar = localStorage.getItem('sidebar');
            if (sidebar === "hidden") { $("html").addClass("sidebar-hidden") }
            else if (sidebar === "visible") { $("html").addClass("sidebar-visible") }
        </script>

        <div id="sidebar" class="sidebar">
            <ul class="chapter"><li class="affix"><a href="preface.html">Preface</a></li><li><a href="background.html"><strong>1.</strong> Background</a></li><li><ul class="section"><li><a href="what.html"><strong>1.1.</strong> What is an OS?</a></li><li><a href="what-kind-is-there.html"><strong>1.2.</strong> What kinds of OS are there?</a></li><li><a href="what-kind-are-we-making.html"><strong>1.3.</strong> What kind are we making?</a></li><li><a href="tools.html"><strong>1.4.</strong> What tools will we use?</a></li></ul></li><li><a href="setup.html"><strong>2.</strong> Setting up a development environment</a></li><li><ul class="section"><li><a href="installing-rust.html"><strong>2.1.</strong> Installing Rust</a></li><li><a href="linux.html"><strong>2.2.</strong> Linux</a></li><li><a href="osx.html"><strong>2.3.</strong> Mac OS X</a></li><li><a href="windows.html"><strong>2.4.</strong> Windows</a></li></ul></li><li><a href="booting-up.html"><strong>3.</strong> Booting up</a></li><li><ul class="section"><li><a href="multiboot-headers.html"><strong>3.1.</strong> Multiboot headers</a></li><li><a href="hello-world.html"><strong>3.2.</strong> Hello, world!</a></li><li><a href="making-an-iso.html"><strong>3.3.</strong> Making an ISO</a></li><li><a href="running-in-qemu.html"><strong>3.4.</strong> Running in QEMU</a></li><li><a href="automation-with-make.html"><strong>3.5.</strong> Automation with Make</a></li></ul></li><li><a href="transitioning-to-long-mode.html"><strong>4.</strong> Transitioning to Long Mode</a></li><li><ul class="section"><li><a href="paging.html"><strong>4.1.</strong> Paging</a></li><li><a href="setting-up-a-gdt.html" class="active"><strong>4.2.</strong> Setting up a GDT</a></li><li><a href="jumping-headlong-into-long-mode.html"><strong>4.3.</strong> Jumping headlong into long mode</a></li></ul></li><li><a href="a-rust-kmain.html"><strong>5.</strong> A Rust kmain()</a></li><li><ul class="section"><li><a href="creating-our-first-crate.html"><strong>5.1.</strong> Creating our first crate</a></li><li><a href="hello-from-rust.html"><strong>5.2.</strong> Hello from Rust!</a></li></ul></li><li><strong>6.</strong> A simple VGA driver</li><li><strong>7.</strong> Keyboard input</li><li><strong>8.</strong> Serial Ports</li><li><strong>9.</strong> Paging</li><li><strong>10.</strong> Running a user-mode program</li><li><strong>11.</strong> Filesystems</li><li><strong>12.</strong> Multitasking</li><li class="spacer"></li><li class="affix"><a href="appendix/troubleshooting.html">Appendix A: Troubleshooting</a></li><li class="affix"><a href="appendix/numeral-systems.html">Appendix B: Numeral Systems</a></li><li class="affix"><a href="appendix/osx-install.html">Appendix C: Mac OS X Install Script</a></li></ul>
        </div>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar" class="menu-bar">
                    <div class="left-buttons">
                        <i id="sidebar-toggle" class="fa fa-bars"></i>
                        <i id="theme-toggle" class="fa fa-paint-brush"></i>
                    </div>

                    <h1 class="menu-title">intermezzOS</h1>

                    <div class="right-buttons">
                        <i id="print-button" class="fa fa-print" title="Print this book"></i>
                    </div>
                </div>

                <div id="content" class="content">
                    <a class="header" href="setting-up-a-gdt.html#setting-up-a-gdt" name="setting-up-a-gdt"><h1>Setting up a GDT</h1></a>
<p>We’re so close! We’re currently in long mode, but not ‘real’ long mode. We need
to go from this ‘compatibility mode’ to honest-to-goodness long mode. To do
this, we need to set up a ‘global descriptor table’.</p>
<p>This table, also known as a GDT, is kind of vestigial. The GDT is used for a
style of memory handling called ‘segmentation’, which is in contrast to the
paging model that we just set up. Even though we’re not using segmentation,
however, we’re still required to have a valid GDT. Such is life.</p>
<p>So let’s set up a minimal GDT. Our GDT will have three entries:</p>
<ul>
<li>a ‘zero entry’</li>
<li>a ‘code segment’</li>
<li>a ‘data segment’</li>
</ul>
<p>If we were going to be using the GDT for real stuff, it could have a number
of code and data segment entries. But we need at least one of each to have a
minimum viable table, so let’s get to it!</p>
<a class="header" href="setting-up-a-gdt.html#the-zero-entry" name="the-zero-entry"><h2>The Zero entry</h2></a>
<p>The first entry in the GDT is special: it needs to be a zero value. Add this
to the bottom of <code>boot.asm</code>:</p>
<pre><code class="language-x86asm">section .rodata
gdt64:
    dq 0
</code></pre>
<p>We have a new section: <code>rodata</code>. This stands for ‘read only data’, and since
we’re not going to modify our GDT, having it be read-only is a good idea.</p>
<p>Next, we have a label: <code>gdt64</code>. We’ll use this label later, to tell the hardware
where our GDT is located.</p>
<p>Finally, <code>dq 0</code>. This is ‘define quad-word’, in other words, a 64-bit value.
Given that it’s a zero entry, it shouldn’t be too surprising that the value of
this entry is zero!</p>
<p>That’s all there is to it.</p>
<a class="header" href="setting-up-a-gdt.html#setting-up-a-code-segment" name="setting-up-a-code-segment"><h2>Setting up a code segment</h2></a>
<p>Next, we need a code segment. Add this below the <code>dq 0</code>:</p>
<pre><code class="language-x86asm">.code: equ $ - gdt64
    dq (1&lt;&lt;44) | (1&lt;&lt;47) | (1&lt;&lt;41) | (1&lt;&lt;43) | (1&lt;&lt;53)
</code></pre>
<p>Let's talk about the <code>dq</code> line first. If you recall from the last section,
<code>1&lt;&lt;44</code> means ‘left shift one 44 places’, which sets the 44th bit. But what
about <code>|</code>? This means <code>or</code>. So, if we <code>or</code> a bunch of these values together,
we’ll end up with a value that has the 44th, 47th, 41st, 43rd, and 53rd bit
set.</p>
<p>Why <code>|</code> and not <code>or</code>, like before? Well, here, we’re not running assembly
instructions: we’re defining some data. So there’s no instruction to execute, so
the language used is a bit different.</p>
<p>Finally, why these bits? Well, as we’ve seen with other table entries, each bit
has a meaning. Here’s a summary:</p>
<ul>
<li>44: ‘descriptor type’: This has to be <code>1</code> for code and data segments</li>
<li>47: ‘present’: This is set to <code>1</code> if the entry is valid</li>
<li>41: ‘read/write’: If this is a code segment, <code>1</code> means that it’s readable</li>
<li>43: ‘executable’: Set to <code>1</code> for code segments</li>
<li>53: ‘64-bit’: if this is a 64-bit GDT, this should be set</li>
</ul>
<p>That’s all we need for a valid code segment!</p>
<p>Oh, but let's not forget about the other line:</p>
<pre><code class="language-x86asm">.code: equ $ - gdt64
</code></pre>
<p>What's up with this? So, in a bit, we'll need to reference this entry somehow.
But we don't reference the entry by its address, we reference it by an offset.
If we needed just an address, we could use <code>code:</code>. But we can't, so we need
more. Also, note that period at the start, it's <code>.code:</code>. This tells the
assembler to scope this label under the last label that appeared, so we'll
say <code>gdt64.code</code> rather than just <code>code</code>. Some nice encapsulation.</p>
<p>So that's what's up with the label, but we still have this <code>equ $ - gdt64</code> bit.
<code>$</code> is the current position. So we're subtracting the current position from the
address of <code>gdt64</code>. Conveniently, that's the offset number we need for later:
how far is this segment past the start of the GDT. The <code>equ</code> sets the address
for the label; in other words, this line is saying &quot;set the <code>.code</code> label's
value to the current address minus the address of <code>gdt64</code>. Got it?</p>
<a class="header" href="setting-up-a-gdt.html#setting-up-a-data-segment" name="setting-up-a-data-segment"><h2>Setting up a data segment</h2></a>
<p>Below the code segment, add this for a data segment:</p>
<pre><code class="language-x86asm">.data: equ $ - gdt64
    dq (1&lt;&lt;44) | (1&lt;&lt;47) | (1&lt;&lt;41)
</code></pre>
<p>We need less bits set for a data segment. But they’re ones we covered before.
The only difference is bit 41; for data segments, a <code>1</code> means that it’s
writable.</p>
<p>We also use the same trick again with the labels, calculating the offset with
<code>equ</code>.</p>
<a class="header" href="setting-up-a-gdt.html#putting-it-all-together" name="putting-it-all-together"><h2>Putting it all together</h2></a>
<p>Here’s our whole GDT:</p>
<pre><code class="language-x86asm">section .rodata
gdt64:
    dq 0
.code: equ $ - gdt64
    dq (1&lt;&lt;44) | (1&lt;&lt;47) | (1&lt;&lt;41) | (1&lt;&lt;43) | (1&lt;&lt;53)
.data: equ $ - gdt64
    dq (1&lt;&lt;44) | (1&lt;&lt;47) | (1&lt;&lt;41)
</code></pre>
<p>We’re so close! Now, to tell the hardware about our GDT. There’s a special
assembly instruction for this: <code>lgdt</code>. But it doesn’t take the GDT itself; it
takes a special structure: two bytes for the length, and eight bytes for the
address. So we have to set <em>that</em> up.</p>
<p>Below these <code>dq</code>s, add this:</p>
<pre><code class="language-x86asm">.pointer:
    dw .pointer - gdt64 - 1
    dq gdt64
</code></pre>
<p>To calculate the length, we take the value of this new label, <code>pointer</code>, and
subtract the value of <code>gdt64</code>, and then subtract one more. We could calculate
this length manually, but if we do it this way, if we add another GDT entry for
some reason, it will automatically correct itself, which is nice.</p>
<p>The <code>dq</code> here has the address of our table. Straightforward.</p>
<a class="header" href="setting-up-a-gdt.html#load-the-gdt" name="load-the-gdt"><h2>Load the GDT</h2></a>
<p>So! We’re finally ready to tell the hardware about our GDT. Add this line after
all of the paging stuff we did in the last chapter:</p>
<pre><code class="language-x86asm">    lgdt [gdt64.pointer]
</code></pre>
<p>We pass <code>lgdt</code> the value of our <code>pointer</code> label. <code>lgdt</code> stands for ‘load global
descriptor table. That’s it!</p>
<p>We have all of the prerequisites done! In the next section, we will complete our
transition by jumping to long mode.</p>

                </div>

                <!-- Mobile navigation buttons -->
                
                    <a href="paging.html" class="mobile-nav-chapters previous">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
                    <a href="jumping-headlong-into-long-mode.html" class="mobile-nav-chapters next">
                        <i class="fa fa-angle-right"></i>
                    </a>
                

            </div>

            
                <a href="paging.html" class="nav-chapters previous" title="You can navigate through the chapters using the arrow keys">
                    <i class="fa fa-angle-left"></i>
                </a>
            

            
                <a href="jumping-headlong-into-long-mode.html" class="nav-chapters next" title="You can navigate through the chapters using the arrow keys">
                    <i class="fa fa-angle-right"></i>
                </a>
            

        </div>


        <!-- Local fallback for Font Awesome -->
        <script>
            if ($(".fa").css("font-family") !== "FontAwesome") {
                $('<link rel="stylesheet" type="text/css" href="_FontAwesome/css/font-awesome.css">').prependTo('head');
            }
        </script>

        <!-- Livereload script (if served using the cli tool) -->
        

        <script src="highlight.js"></script>
        <script src="book.js"></script>
    </body>
</html>
